<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LernTrainer ‚Äì Interaktiv lernen f√ºr Klasse 7-10</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --secondary: #2b6cb0;
            --accent: #ed8936;
            --success: #38a169;
            --error: #e53e3e;
            --warning: #d69e2e;
            --bg: #f7fafc;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
        }

        /* ==================== LOGIN SCREEN ==================== */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 24px;
            padding: 50px 40px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            text-align: center;
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 1.05rem;
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.1rem;
            font-family: inherit;
            border: 3px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 4px rgba(43, 108, 176, 0.15);
        }

        .login-input.error {
            border-color: var(--error);
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: inherit;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26, 54, 93, 0.3);
        }

        .login-error {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .login-hint {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-light);
            font-size: 0.85rem;
        }

        /* ==================== MAIN APP ==================== */
        .app-container {
            display: none;
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-container.show {
            display: block;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .app-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-header-logo {
            font-size: 2.5rem;
        }

        .app-header h1 {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .app-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Progress Bar */
        .progress-section {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--primary);
        }

        .progress-stats {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .progress-bar {
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #48bb78);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Selection Cards */
        .selection-section {
            background: var(--card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }

        .selection-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .selection-btn {
            padding: 20px 15px;
            border: 3px solid var(--border);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
            text-align: center;
        }

        .selection-btn:hover:not(.disabled) {
            border-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .selection-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
        }

        .selection-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selection-btn .icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .selection-btn .label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .selection-btn .sublabel {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Topic List */
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .topic-card {
            padding: 20px;
            border: 3px solid var(--border);
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .topic-card:hover:not(.disabled):not(.coming-soon) {
            border-color: var(--secondary);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .topic-card.coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .topic-card.coming-soon::after {
            content: "Bald verf√ºgbar";
            position: absolute;
            top: 10px;
            right: -30px;
            background: var(--warning);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 35px;
            transform: rotate(45deg);
        }

        .topic-card .topic-icon {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .topic-card .topic-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.05rem;
            margin-bottom: 5px;
        }

        .topic-card .topic-desc {
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.4;
        }

        .topic-card .topic-meta {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .topic-card .topic-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        .topic-tag.questions {
            background: #ebf8ff;
            color: var(--secondary);
        }

        .topic-tag.audio {
            background: #f0fff4;
            color: var(--success);
        }

        .topic-tag.completed {
            background: #c6f6d5;
            color: #276749;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--card);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .breadcrumb-item.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .breadcrumb-item.clickable:hover {
            background: var(--border);
        }

        .breadcrumb-arrow {
            color: var(--text-light);
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Quiz Container (embedded) */
        .quiz-container {
            background: var(--card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            display: none;
        }

        .quiz-container.show {
            display: block;
        }

        /* Stats Bar in Quiz */
        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quiz-stat {
            background: var(--bg);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .quiz-stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .quiz-stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .quiz-stat.correct .quiz-stat-value { color: var(--success); }
        .quiz-stat.wrong .quiz-stat-value { color: var(--error); }
        .quiz-stat.percent .quiz-stat-value { color: var(--accent); }

        /* Audio Mode Toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #ebf8ff, #e6fffa);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .mode-toggle-label {
            font-weight: 600;
            color: var(--primary);
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: "";
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            left: 32px;
        }

        .mode-toggle-desc {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Question Area */
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .question-type-badge {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .question-tense-badge {
            background: var(--accent);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .question-number {
            font-family: 'Space Mono', monospace;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .sentence-box {
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 1rem;
            line-height: 1.8;
            border-left: 4px solid var(--secondary);
        }

        /* Audio Controls */
        .audio-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .audio-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-btn.speak {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .audio-btn.listen {
            background: linear-gradient(135deg, var(--success), #2f855a);
            color: white;
        }

        .audio-btn:hover {
            transform: scale(1.05);
        }

        .audio-btn.speaking, .audio-btn.listening {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Voice Visualizer */
        .voice-visualizer {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .voice-visualizer.active { display: flex; }

        .voice-bar {
            width: 6px;
            height: 30px;
            background: white;
            border-radius: 3px;
            animation: voiceBar 0.5s ease-in-out infinite;
        }

        .voice-bar:nth-child(1) { animation-delay: 0s; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes voiceBar {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 40px; opacity: 1; }
        }

        .voice-status {
            color: white;
            font-weight: 600;
            margin-left: 15px;
        }

        .recognized-text {
            background: #ebf8ff;
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Space Mono', monospace;
            min-height: 50px;
            display: none;
        }

        .recognized-text.show { display: block; }

        .recognized-text .label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-family: 'Outfit', sans-serif;
        }

        /* Answer Input */
        .answer-input {
            width: 100%;
            padding: 16px 18px;
            font-size: 1rem;
            font-family: 'Space Mono', monospace;
            border: 3px solid var(--border);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: var(--bg);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
            box-shadow: 0 0 0 4px rgba(43, 108, 176, 0.15);
        }

        .answer-input.correct { border-color: var(--success); background: #f0fff4; }
        .answer-input.incorrect { border-color: var(--error); background: #fff5f5; }

        /* Options Grid */
        .options-grid { display: grid; gap: 10px; margin-bottom: 15px; }

        .option-btn {
            padding: 15px 18px;
            border: 3px solid var(--border);
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            text-align: left;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-btn:hover:not(.disabled) {
            border-color: var(--secondary);
            background: white;
            transform: translateX(5px);
        }

        .option-btn.selected { border-color: var(--primary); background: #ebf8ff; }
        .option-btn.correct { border-color: var(--success); background: #f0fff4; }
        .option-btn.incorrect { border-color: var(--error); background: #fff5f5; }
        .option-btn.disabled { cursor: default; }

        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        /* Buttons */
        .btn-row { display: flex; gap: 12px; flex-wrap: wrap; }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.3);
        }

        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Feedback */
        .feedback {
            padding: 18px;
            border-radius: 12px;
            margin-top: 15px;
            display: none;
        }

        .feedback.show { display: block; animation: slideIn 0.4s ease; }
        .feedback.correct { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); border-left: 5px solid var(--success); }
        .feedback.incorrect { background: linear-gradient(135deg, #fed7d7, #feb2b2); border-left: 5px solid var(--error); }

        .feedback-title { font-weight: 700; font-size: 1.05rem; margin-bottom: 8px; }
        .feedback-text { line-height: 1.6; }

        .correct-answer {
            font-family: 'Space Mono', monospace;
            background: rgba(255,255,255,0.8);
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }

        /* Result Screen */
        .result-screen {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .result-screen.show { display: block; }

        .result-emoji { font-size: 70px; margin-bottom: 15px; }
        .result-title { font-size: 1.8rem; color: var(--primary); margin-bottom: 12px; }
        .result-score { font-size: 2.8rem; font-weight: 700; color: var(--success); font-family: 'Space Mono', monospace; }
        .result-text { color: var(--text-light); margin-bottom: 25px; }

        /* Theory Section */
        .theory-toggle {
            background: none;
            border: 2px solid var(--secondary);
            color: var(--secondary);
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .theory-toggle:hover { background: var(--secondary); color: white; }

        .theory-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .theory-section.show { display: block; }

        .theory-section h3 { color: var(--primary); margin-bottom: 12px; }
        .theory-section h4 { color: var(--secondary); margin: 15px 0 8px; }

        .theory-section table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.9rem;
        }

        .theory-section th, .theory-section td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: left;
        }

        .theory-section th { background: var(--primary); color: white; }
        .theory-section code { background: #edf2f7; padding: 2px 6px; border-radius: 4px; font-family: 'Space Mono', monospace; }

        .rule-box {
            background: #ebf8ff;
            border: 2px solid var(--secondary);
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
        }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header { flex-direction: column; text-align: center; }
            .app-header-left { flex-direction: column; }
            .selection-grid { grid-template-columns: repeat(2, 1fr); }
            .quiz-stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 480px) {
            .login-box { padding: 30px 20px; }
            .selection-grid { grid-template-columns: 1fr 1fr; }
            .topic-grid { grid-template-columns: 1fr; }
            .btn { width: 100%; justify-content: center; }
            .audio-btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">üéì</div>
            <h1 class="login-title">LernTrainer</h1>
            <p class="login-subtitle">Interaktiv lernen f√ºr Klasse 7-10</p>
            
            <input type="password" class="login-input" id="passwordInput" placeholder="Passwort eingeben" autocomplete="off">
            <button class="login-btn" id="loginBtn">üîì Anmelden</button>
            
            <p class="login-error" id="loginError">‚ùå Falsches Passwort. Bitte erneut versuchen.</p>
            
            <p class="login-hint">
                üí° Das Passwort erh√§ltst du von deiner Lehrkraft.
            </p>
        </div>
    </div>

    <!-- ==================== MAIN APP ==================== -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="app-header-left">
                <span class="app-header-logo">üéì</span>
                <div>
                    <h1>LernTrainer</h1>
                    <p>Willkommen zur√ºck!</p>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">üö™ Abmelden</button>
        </header>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <span class="progress-title">üìä Dein Gesamtfortschritt</span>
                <span class="progress-stats" id="progressStats">0 Module abgeschlossen</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb" id="breadcrumb"></div>

        <!-- Selection: Grade -->
        <div class="selection-section" id="gradeSelection">
            <h2 class="selection-title">üìö W√§hle deine Klassenstufe</h2>
            <div class="selection-grid" id="gradeGrid"></div>
        </div>

        <!-- Selection: Subject -->
        <div class="selection-section" id="subjectSelection" style="display: none;">
            <h2 class="selection-title">üìñ W√§hle ein Fach</h2>
            <div class="selection-grid" id="subjectGrid"></div>
        </div>

        <!-- Selection: Topic -->
        <div class="selection-section" id="topicSelection" style="display: none;">
            <h2 class="selection-title">üéØ W√§hle ein Thema</h2>
            <div class="topic-grid" id="topicGrid"></div>
        </div>

        <!-- Quiz Container -->
        <div class="quiz-container" id="quizContainer">
            <button class="back-btn" id="backToTopics">‚Üê Zur√ºck zur Themenauswahl</button>
            
            <!-- Audio Mode Toggle -->
            <div class="mode-toggle" id="modeToggle">
                <span class="mode-toggle-label">üé§ Audio-Modus</span>
                <div class="toggle-switch" id="audioToggle"></div>
                <span class="mode-toggle-desc">Fragen h√∂ren, Antworten sprechen</span>
            </div>

            <!-- Theory -->
            <button class="theory-toggle" id="theoryToggle">üìñ Theorie anzeigen</button>
            <div class="theory-section" id="theorySection"></div>

            <!-- Stats -->
            <div class="quiz-stats" id="quizStats">
                <div class="quiz-stat"><div class="quiz-stat-value" id="statTotal">0</div><div class="quiz-stat-label">Fragen</div></div>
                <div class="quiz-stat correct"><div class="quiz-stat-value" id="statCorrect">0</div><div class="quiz-stat-label">Richtig</div></div>
                <div class="quiz-stat wrong"><div class="quiz-stat-value" id="statWrong">0</div><div class="quiz-stat-label">Falsch</div></div>
                <div class="quiz-stat percent"><div class="quiz-stat-value" id="statPercent">0%</div><div class="quiz-stat-label">Quote</div></div>
            </div>

            <!-- Question Area -->
            <div id="questionArea">
                <div class="question-header">
                    <span class="question-type-badge" id="questionType">L√ºckentext</span>
                    <span class="question-tense-badge" id="questionTense">Simple Present</span>
                    <span class="question-number" id="questionNumber">Frage 1/12</span>
                </div>

                <div class="audio-controls" id="audioControls" style="display: none;">
                    <button class="audio-btn speak" id="speakBtn">üîä Vorlesen</button>
                    <button class="audio-btn listen" id="listenBtn">üé§ Sprechen</button>
                </div>

                <div class="voice-visualizer" id="voiceVisualizer">
                    <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
                    <span class="voice-status" id="voiceStatus">Ich h√∂re zu...</span>
                </div>

                <div class="recognized-text" id="recognizedText">
                    <div class="label">Erkannt:</div>
                    <div id="recognizedContent"></div>
                </div>

                <div class="question-text" id="questionText"></div>
                <div id="answerArea"></div>

                <div class="feedback" id="feedback">
                    <div class="feedback-title" id="feedbackTitle"></div>
                    <div class="feedback-text" id="feedbackText"></div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-primary" id="checkBtn">‚úì √úberpr√ºfen</button>
                    <button class="btn btn-secondary" id="nextBtn" style="display: none;">N√§chste Frage ‚Üí</button>
                </div>
            </div>

            <!-- Result -->
            <div class="result-screen" id="resultScreen">
                <div class="result-emoji" id="resultEmoji">üéâ</div>
                <h2 class="result-title" id="resultTitle">Super gemacht!</h2>
                <div class="result-score" id="resultScore">80%</div>
                <p class="result-text" id="resultText">Du hast 8 von 10 Fragen richtig.</p>
                <div class="btn-row" style="justify-content: center;">
                    <button class="btn btn-primary" id="restartBtn">üîÑ Nochmal √ºben</button>
                    <button class="btn btn-secondary" id="backToTopicsResult">üìö Andere Themen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION
        // =====================================================
        const CONFIG = {
            password: "lernen2024",  // Einfach hier √§ndern
            questionsPerQuiz: 12
        };

        // =====================================================
        // DATA STRUCTURE
        // =====================================================
        const GRADES = [
            { id: 7, name: "Klasse 7", icon: "7Ô∏è‚É£" },
            { id: 8, name: "Klasse 8", icon: "8Ô∏è‚É£" },
            { id: 9, name: "Klasse 9", icon: "9Ô∏è‚É£" },
            { id: 10, name: "Klasse 10", icon: "üîü" }
        ];

        const SUBJECTS = [
            { id: "englisch", name: "Englisch", icon: "üá¨üáß" },
            { id: "deutsch", name: "Deutsch", icon: "üìù" },
            { id: "mathe", name: "Mathematik", icon: "üìê" },
            { id: "geschichte", name: "Geschichte", icon: "üèõÔ∏è" },
            { id: "biologie", name: "Biologie", icon: "üß¨" },
            { id: "physik", name: "Physik", icon: "‚ö°" },
            { id: "chemie", name: "Chemie", icon: "üß™" },
            { id: "latein", name: "Latein", icon: "üè∫" }
        ];

        // Topics Database - expandable
        const TOPICS = {
            // Englisch Klasse 7
            "7-englisch": [
                {
                    id: "passive-voice",
                    name: "Passive Voice",
                    desc: "Das Passiv in verschiedenen Zeitformen",
                    icon: "üîÑ",
                    questions: 50,
                    hasAudio: true,
                    theory: `
                        <h3>üìö Das Passive Voice</h3>
                        <div class="rule-box">
                            <strong>Grundregel:</strong> Passiv = Form von <code>be</code> + <code>past participle</code>
                        </div>
                        <h4>Zeitformen</h4>
                        <table>
                            <tr><th>Zeitform</th><th>Form</th><th>Beispiel</th></tr>
                            <tr><td>Simple Present</td><td>am/is/are + pp</td><td>English <strong>is spoken</strong> here.</td></tr>
                            <tr><td>Simple Past</td><td>was/were + pp</td><td>The house <strong>was built</strong> in 1950.</td></tr>
                            <tr><td>Present Perfect</td><td>have/has been + pp</td><td>The letter <strong>has been sent</strong>.</td></tr>
                        </table>
                    `,
                    questionData: [
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "English _____ (speak) in many countries.", answer: "is spoken", alternativeAnswers: ["English is spoken in many countries"], tense: "Simple Present" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "The house _____ (build) in 1950.", answer: "was built", alternativeAnswers: ["The house was built in 1950"], tense: "Simple Past" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "The letter _____ already _____ (send).", answer: "has already been sent", alternativeAnswers: ["has been sent"], tense: "Present Perfect" },
                        { type: "transform", instruction: "Wandle ins Passive um:", sentence: "They speak English here.", answer: "English is spoken here.", alternativeAnswers: [], tense: "Simple Present" },
                        { type: "transform", instruction: "Wandle ins Passive um:", sentence: "Someone stole my bike.", answer: "My bike was stolen.", alternativeAnswers: [], tense: "Simple Past" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "Haggis _____ (make) from sheep's stomach.", answer: "is made", alternativeAnswers: ["Haggis is made from sheeps stomach"], tense: "Simple Present" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "Penicillin _____ (discover) by Alexander Fleming.", answer: "was discovered", alternativeAnswers: ["Penicillin was discovered by Alexander Fleming"], tense: "Simple Past" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "Whisky _____ (produce) in Scotland for centuries.", answer: "has been produced", alternativeAnswers: ["Whisky has been produced in Scotland for centuries"], tense: "Present Perfect" },
                        { type: "choice", instruction: "W√§hle die richtige Passivform:", sentence: "The windows _____ every week.", options: ["is cleaned", "are cleaned", "was cleaned", "were cleaned"], correctIndex: 1, tense: "Simple Present" },
                        { type: "choice", instruction: "W√§hle die richtige Passivform:", sentence: "The car _____ yesterday.", options: ["is repaired", "are repaired", "was repaired", "were repaired"], correctIndex: 2, tense: "Simple Past" },
                        { type: "transform", instruction: "Wandle ins Passive um:", sentence: "People have read this book many times.", answer: "This book has been read many times.", alternativeAnswers: [], tense: "Present Perfect" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "The Sherlock Holmes stories _____ (write) by Conan Doyle.", answer: "were written", alternativeAnswers: ["The Sherlock Holmes stories were written by Conan Doyle"], tense: "Simple Past" },
                        { type: "fillblank", instruction: "Setze die richtige Passivform ein:", sentence: "Ships _____ (build) in Glasgow.", answer: "are built", alternativeAnswers: ["Ships are built in Glasgow"], tense: "Simple Present" },
                        { type: "choice", instruction: "Welcher Satz ist Passive?", sentence: "", options: ["She writes letters.", "Letters are written.", "They build houses.", "He reads books."], correctIndex: 1, tense: "Erkennung" },
                        { type: "transform", instruction: "Wandle ins Passive um:", sentence: "They clean the rooms every day.", answer: "The rooms are cleaned every day.", alternativeAnswers: [], tense: "Simple Present" }
                    ]
                },
                {
                    id: "simple-past",
                    name: "Simple Past",
                    desc: "Regelm√§√üige und unregelm√§√üige Verben",
                    icon: "‚èÆÔ∏è",
                    questions: 0,
                    hasAudio: true,
                    comingSoon: true
                }
            ],
            // Deutsch Klasse 7
            "7-deutsch": [
                {
                    id: "konjunktiv",
                    name: "Konjunktiv I & II",
                    desc: "Indirekte Rede und irreale Bedingungen",
                    icon: "üí≠",
                    questions: 0,
                    hasAudio: false,
                    comingSoon: true
                }
            ],
            // Mathe Klasse 7
            "7-mathe": [
                {
                    id: "prozent",
                    name: "Prozentrechnung",
                    desc: "Grundwert, Prozentwert, Prozentsatz",
                    icon: "%",
                    questions: 0,
                    hasAudio: false,
                    comingSoon: true
                }
            ],
            // Default for other combinations
            "default": [
                {
                    id: "coming-soon",
                    name: "In Arbeit...",
                    desc: "Neue Themen werden bald hinzugef√ºgt",
                    icon: "üöß",
                    questions: 0,
                    comingSoon: true
                }
            ]
        };

        // =====================================================
        // SPEECH API
        // =====================================================
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let finalTranscript = '';

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-GB';
        }

        function speak(text, lang = 'en-GB') {
            if (!synth) return;
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.9;
            const voices = synth.getVoices();
            const voice = voices.find(v => v.lang === lang) || voices.find(v => v.lang.startsWith(lang.split('-')[0]));
            if (voice) utterance.voice = voice;
            utterance.onend = () => document.getElementById('speakBtn')?.classList.remove('speaking');
            document.getElementById('speakBtn')?.classList.add('speaking');
            synth.speak(utterance);
        }

        if (synth) synth.onvoiceschanged = () => synth.getVoices();

        function startListening() {
            if (!recognition || isListening) return;
            finalTranscript = '';
            document.getElementById('recognizedContent').textContent = '';
            document.getElementById('recognizedText').classList.add('show');
            document.getElementById('voiceVisualizer').classList.add('active');
            document.getElementById('listenBtn').classList.add('listening');
            document.getElementById('listenBtn').innerHTML = '‚èπÔ∏è Stopp';
            isListening = true;
            recognition.start();
        }

        function stopListening() {
            if (!recognition || !isListening) return;
            recognition.stop();
        }

        if (recognition) {
            recognition.onresult = (event) => {
                let interim = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    else interim += event.results[i][0].transcript;
                }
                document.getElementById('recognizedContent').textContent = finalTranscript + interim;
                const input = document.getElementById('answerInput');
                if (input) input.value = finalTranscript + interim;
            };
            recognition.onend = () => {
                isListening = false;
                document.getElementById('voiceVisualizer').classList.remove('active');
                document.getElementById('listenBtn').classList.remove('listening');
                document.getElementById('listenBtn').innerHTML = 'üé§ Sprechen';
            };
            recognition.onerror = () => {
                isListening = false;
                document.getElementById('voiceVisualizer').classList.remove('active');
                document.getElementById('listenBtn').classList.remove('listening');
                document.getElementById('listenBtn').innerHTML = 'üé§ Sprechen';
            };
        }

        // =====================================================
        // APP STATE
        // =====================================================
        let state = {
            loggedIn: false,
            selectedGrade: null,
            selectedSubject: null,
            selectedTopic: null,
            audioMode: false,
            questions: [],
            currentIndex: 0,
            correct: 0,
            wrong: 0,
            answered: false,
            completedModules: []
        };

        // Load from LocalStorage
        function loadProgress() {
            const saved = localStorage.getItem('lerntrainer_progress');
            if (saved) {
                const data = JSON.parse(saved);
                state.completedModules = data.completedModules || [];
            }
        }

        function saveProgress() {
            localStorage.setItem('lerntrainer_progress', JSON.stringify({
                completedModules: state.completedModules
            }));
        }

        // =====================================================
        // UI FUNCTIONS
        // =====================================================
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('show');
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            showGradeSelection();
            updateProgressBar();
        }

        function showGradeSelection() {
            document.getElementById('gradeSelection').style.display = 'block';
            document.getElementById('subjectSelection').style.display = 'none';
            document.getElementById('topicSelection').style.display = 'none';
            document.getElementById('quizContainer').classList.remove('show');
            document.getElementById('progressSection').style.display = 'block';
            state.selectedGrade = null;
            state.selectedSubject = null;
            updateBreadcrumb();
        }

        function showSubjectSelection() {
            document.getElementById('gradeSelection').style.display = 'none';
            document.getElementById('subjectSelection').style.display = 'block';
            document.getElementById('topicSelection').style.display = 'none';
            document.getElementById('quizContainer').classList.remove('show');
            state.selectedSubject = null;
            updateBreadcrumb();
        }

        function showTopicSelection() {
            document.getElementById('gradeSelection').style.display = 'none';
            document.getElementById('subjectSelection').style.display = 'none';
            document.getElementById('topicSelection').style.display = 'block';
            document.getElementById('quizContainer').classList.remove('show');
            renderTopics();
            updateBreadcrumb();
        }

        function showQuiz() {
            document.getElementById('gradeSelection').style.display = 'none';
            document.getElementById('subjectSelection').style.display = 'none';
            document.getElementById('topicSelection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('quizContainer').classList.add('show');
            document.getElementById('questionArea').style.display = 'block';
            document.getElementById('resultScreen').classList.remove('show');
            document.getElementById('breadcrumb').innerHTML = '';
            startQuiz();
        }

        function updateBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            let html = '';
            
            html += `<div class="breadcrumb-item clickable" onclick="showGradeSelection()">üè† Start</div>`;
            
            if (state.selectedGrade) {
                html += `<span class="breadcrumb-arrow">‚Üí</span>`;
                html += `<div class="breadcrumb-item ${state.selectedSubject ? 'clickable' : ''}" ${state.selectedSubject ? 'onclick="showSubjectSelection()"' : ''}>Klasse ${state.selectedGrade}</div>`;
            }
            
            if (state.selectedSubject) {
                const subject = SUBJECTS.find(s => s.id === state.selectedSubject);
                html += `<span class="breadcrumb-arrow">‚Üí</span>`;
                html += `<div class="breadcrumb-item">${subject.icon} ${subject.name}</div>`;
            }
            
            bc.innerHTML = html;
        }

        function updateProgressBar() {
            const totalModules = Object.values(TOPICS).flat().filter(t => !t.comingSoon).length;
            const completed = state.completedModules.length;
            const percent = totalModules > 0 ? Math.round((completed / totalModules) * 100) : 0;
            
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressStats').textContent = `${completed} von ${totalModules} Modulen abgeschlossen`;
        }

        // =====================================================
        // RENDER FUNCTIONS
        // =====================================================
        function renderGrades() {
            const grid = document.getElementById('gradeGrid');
            grid.innerHTML = GRADES.map(g => `
                <button class="selection-btn" data-grade="${g.id}">
                    <span class="icon">${g.icon}</span>
                    <span class="label">${g.name}</span>
                </button>
            `).join('');
        }

        function renderSubjects() {
            const grid = document.getElementById('subjectGrid');
            grid.innerHTML = SUBJECTS.map(s => `
                <button class="selection-btn" data-subject="${s.id}">
                    <span class="icon">${s.icon}</span>
                    <span class="label">${s.name}</span>
                </button>
            `).join('');
        }

        function renderTopics() {
            const grid = document.getElementById('topicGrid');
            const key = `${state.selectedGrade}-${state.selectedSubject}`;
            const topics = TOPICS[key] || TOPICS['default'];
            
            grid.innerHTML = topics.map(t => {
                const moduleId = `${key}-${t.id}`;
                const isCompleted = state.completedModules.includes(moduleId);
                
                return `
                    <button class="topic-card ${t.comingSoon ? 'coming-soon' : ''}" data-topic="${t.id}" ${t.comingSoon ? 'disabled' : ''}>
                        <div class="topic-icon">${t.icon}</div>
                        <div class="topic-name">${t.name}</div>
                        <div class="topic-desc">${t.desc}</div>
                        <div class="topic-meta">
                            ${t.questions > 0 ? `<span class="topic-tag questions">${t.questions} Fragen</span>` : ''}
                            ${t.hasAudio ? '<span class="topic-tag audio">üé§ Audio</span>' : ''}
                            ${isCompleted ? '<span class="topic-tag completed">‚úì Abgeschlossen</span>' : ''}
                        </div>
                    </button>
                `;
            }).join('');
        }

        // =====================================================
        // QUIZ FUNCTIONS
        // =====================================================
        function startQuiz() {
            const key = `${state.selectedGrade}-${state.selectedSubject}`;
            const topics = TOPICS[key] || TOPICS['default'];
            const topic = topics.find(t => t.id === state.selectedTopic);
            
            if (!topic || !topic.questionData) return;
            
            // Setup
            state.questions = shuffleArray([...topic.questionData]).slice(0, CONFIG.questionsPerQuiz);
            state.currentIndex = 0;
            state.correct = 0;
            state.wrong = 0;
            state.answered = false;
            
            // Theory
            document.getElementById('theorySection').innerHTML = topic.theory || '';
            document.getElementById('theorySection').classList.remove('show');
            
            // Audio mode
            document.getElementById('modeToggle').style.display = topic.hasAudio ? 'flex' : 'none';
            document.getElementById('audioControls').style.display = state.audioMode && topic.hasAudio ? 'flex' : 'none';
            
            updateQuizStats();
            showQuestion();
        }

        function showQuestion() {
            const q = state.questions[state.currentIndex];
            state.answered = false;
            
            // Reset audio UI
            document.getElementById('recognizedText').classList.remove('show');
            document.getElementById('voiceVisualizer').classList.remove('active');
            
            // Header
            document.getElementById('questionNumber').textContent = `Frage ${state.currentIndex + 1}/${state.questions.length}`;
            document.getElementById('questionType').textContent = {
                'fillblank': 'L√ºckentext',
                'transform': 'Umwandeln',
                'choice': 'Multiple Choice'
            }[q.type] || q.type;
            document.getElementById('questionTense').textContent = q.tense || '';
            
            // Question
            let html = `<p>${q.instruction}</p>`;
            if (q.sentence) html += `<div class="sentence-box">${q.sentence}</div>`;
            document.getElementById('questionText').innerHTML = html;
            
            // Answer area
            const area = document.getElementById('answerArea');
            if (q.type === 'choice') {
                area.innerHTML = `<div class="options-grid">${q.options.map((opt, i) => `
                    <button class="option-btn" data-index="${i}">
                        <span class="option-letter">${String.fromCharCode(65 + i)}</span>
                        ${opt}
                    </button>
                `).join('')}</div>`;
            } else {
                area.innerHTML = `<input type="text" class="answer-input" id="answerInput" placeholder="${state.audioMode ? 'Deine Antwort erscheint hier...' : 'Deine Antwort eingeben...'}" autocomplete="off" spellcheck="false">`;
                if (!state.audioMode) setTimeout(() => document.getElementById('answerInput')?.focus(), 100);
            }
            
            // Audio
            if (state.audioMode) {
                setTimeout(() => speak(q.instruction.replace(/<[^>]*>/g, '') + ' ' + (q.sentence || '')), 300);
            }
            
            // Buttons
            document.getElementById('checkBtn').style.display = 'inline-flex';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');
        }

        function checkAnswer() {
            const q = state.questions[state.currentIndex];
            let isCorrect = false;
            
            if (q.type === 'choice') {
                const selected = document.querySelector('.option-btn.selected');
                if (!selected) { alert('Bitte w√§hle eine Antwort!'); return; }
                isCorrect = parseInt(selected.dataset.index) === q.correctIndex;
                document.querySelectorAll('.option-btn').forEach((btn, i) => {
                    btn.classList.add('disabled');
                    if (i === q.correctIndex) btn.classList.add('correct');
                    else if (btn.classList.contains('selected') && !isCorrect) btn.classList.add('incorrect');
                });
            } else {
                const input = document.getElementById('answerInput');
                const userAnswer = input.value.trim();
                if (!userAnswer) { alert('Bitte gib eine Antwort ein!'); return; }
                
                const normalize = s => s.toLowerCase().replace(/[.,!?'"]/g, '').replace(/\s+/g, ' ').trim();
                isCorrect = normalize(userAnswer) === normalize(q.answer);
                if (!isCorrect && q.alternativeAnswers) {
                    isCorrect = q.alternativeAnswers.some(a => normalize(a) === normalize(userAnswer));
                }
                
                // Flexible matching
                if (!isCorrect && q.type === 'fillblank') {
                    const words = normalize(q.answer).split(' ');
                    const userWords = normalize(userAnswer).split(' ');
                    if (words.every(w => userWords.includes(w))) isCorrect = true;
                }
                
                input.classList.add(isCorrect ? 'correct' : 'incorrect');
                input.disabled = true;
            }
            
            if (isCorrect) state.correct++; else state.wrong++;
            updateQuizStats();
            
            // Feedback
            const fb = document.getElementById('feedback');
            fb.className = 'feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            document.getElementById('feedbackTitle').innerHTML = isCorrect ? '‚úÖ Richtig!' : '‚ùå Nicht ganz richtig';
            document.getElementById('feedbackText').innerHTML = isCorrect ? '' : `Die richtige Antwort: <span class="correct-answer">${q.answer}</span>`;
            
            if (state.audioMode) speak(isCorrect ? 'Correct!' : 'The correct answer is: ' + q.answer);
            
            state.answered = true;
            document.getElementById('checkBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'inline-flex';
            document.getElementById('nextBtn').textContent = state.currentIndex < state.questions.length - 1 ? 'N√§chste Frage ‚Üí' : 'Ergebnis ‚Üí';
        }

        function nextQuestion() {
            state.currentIndex++;
            if (state.currentIndex < state.questions.length) showQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('questionArea').style.display = 'none';
            document.getElementById('resultScreen').classList.add('show');
            
            const percent = Math.round((state.correct / state.questions.length) * 100);
            let emoji = 'üí™', title = 'Weiter √ºben!';
            if (percent >= 90) { emoji = 'üèÜ'; title = 'Hervorragend!'; }
            else if (percent >= 70) { emoji = 'üéâ'; title = 'Sehr gut!'; }
            else if (percent >= 50) { emoji = 'üëç'; title = 'Gut gemacht!'; }
            
            document.getElementById('resultEmoji').textContent = emoji;
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultScore').textContent = percent + '%';
            document.getElementById('resultText').textContent = `Du hast ${state.correct} von ${state.questions.length} Fragen richtig.`;
            
            // Mark as completed
            if (percent >= 70) {
                const moduleId = `${state.selectedGrade}-${state.selectedSubject}-${state.selectedTopic}`;
                if (!state.completedModules.includes(moduleId)) {
                    state.completedModules.push(moduleId);
                    saveProgress();
                }
            }
        }

        function updateQuizStats() {
            document.getElementById('statTotal').textContent = state.questions.length;
            document.getElementById('statCorrect').textContent = state.correct;
            document.getElementById('statWrong').textContent = state.wrong;
            const total = state.correct + state.wrong;
            document.getElementById('statPercent').textContent = (total > 0 ? Math.round((state.correct / total) * 100) : 0) + '%';
        }

        function shuffleArray(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            renderGrades();
            renderSubjects();
            
            // Check session
            if (sessionStorage.getItem('lerntrainer_logged_in')) {
                showApp();
            }
            
            // Login
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('passwordInput').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
            
            function handleLogin() {
                const pw = document.getElementById('passwordInput').value;
                if (pw === CONFIG.password) {
                    sessionStorage.setItem('lerntrainer_logged_in', 'true');
                    showApp();
                } else {
                    document.getElementById('passwordInput').classList.add('error');
                    document.getElementById('loginError').classList.add('show');
                    setTimeout(() => {
                        document.getElementById('passwordInput').classList.remove('error');
                    }, 500);
                }
            }
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.removeItem('lerntrainer_logged_in');
                showLogin();
            });
            
            // Grade selection
            document.getElementById('gradeGrid').addEventListener('click', e => {
                const btn = e.target.closest('.selection-btn');
                if (!btn) return;
                document.querySelectorAll('#gradeGrid .selection-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.selectedGrade = parseInt(btn.dataset.grade);
                setTimeout(showSubjectSelection, 200);
            });
            
            // Subject selection
            document.getElementById('subjectGrid').addEventListener('click', e => {
                const btn = e.target.closest('.selection-btn');
                if (!btn) return;
                document.querySelectorAll('#subjectGrid .selection-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.selectedSubject = btn.dataset.subject;
                setTimeout(showTopicSelection, 200);
            });
            
            // Topic selection
            document.getElementById('topicGrid').addEventListener('click', e => {
                const card = e.target.closest('.topic-card');
                if (!card || card.classList.contains('coming-soon')) return;
                state.selectedTopic = card.dataset.topic;
                showQuiz();
            });
            
            // Quiz controls
            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('restartBtn').addEventListener('click', () => {
                document.getElementById('questionArea').style.display = 'block';
                document.getElementById('resultScreen').classList.remove('show');
                startQuiz();
            });
            document.getElementById('backToTopics').addEventListener('click', () => {
                if (synth) synth.cancel();
                showTopicSelection();
                document.getElementById('progressSection').style.display = 'block';
                updateProgressBar();
            });
            document.getElementById('backToTopicsResult').addEventListener('click', () => {
                showTopicSelection();
                document.getElementById('progressSection').style.display = 'block';
                updateProgressBar();
            });
            
            // Theory toggle
            document.getElementById('theoryToggle').addEventListener('click', () => {
                document.getElementById('theorySection').classList.toggle('show');
            });
            
            // Audio mode toggle
            document.getElementById('audioToggle').addEventListener('click', () => {
                state.audioMode = !state.audioMode;
                document.getElementById('audioToggle').classList.toggle('active', state.audioMode);
                document.getElementById('audioControls').style.display = state.audioMode ? 'flex' : 'none';
            });
            
            // Audio buttons
            document.getElementById('speakBtn').addEventListener('click', () => {
                const q = state.questions[state.currentIndex];
                speak(q.instruction.replace(/<[^>]*>/g, '') + ' ' + (q.sentence || ''));
            });
            document.getElementById('listenBtn').addEventListener('click', () => {
                if (isListening) stopListening(); else startListening();
            });
            
            // Option selection
            document.getElementById('answerArea').addEventListener('click', e => {
                const btn = e.target.closest('.option-btn');
                if (!btn || state.answered) return;
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            });
            
            // Enter key
            document.addEventListener('keydown', e => {
                if (e.key === 'Enter' && document.getElementById('quizContainer').classList.contains('show')) {
                    if (!state.answered) checkAnswer();
                    else nextQuestion();
                }
            });
        });
    </script>
</body>
</html>
